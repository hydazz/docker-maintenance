#!/usr/bin/with-contenv bash

if [ ! -d /swag ]; then
  echo "SWAG appdata is not mounted to /swag, this image is intended to be used with SWAG and startup errors will occur if its appdata not mounted."
  echo "Please re-start the container with SWAG appdata mounted to /swag"
  sleep infinity
fi

# make our folders
mkdir -p \
  /config/{nginx/site-confs,nginx/proxy-confs,public_html,log/nginx} \
  /run \
  /var/lib/nginx/tmp/client_body \
  /var/tmp/nginx

# copy config files
[[ ! -f /config/nginx/nginx.conf ]] &&
  cp /defaults/nginx.conf /config/nginx/nginx.conf
[[ ! -f /config/nginx/site-confs/default.conf ]] &&
  cp /defaults/default.conf /config/nginx/site-confs/default.conf
[[ $(find /config/public_html -type f | wc -l) -eq 0 ]] &&
  cp /defaults/index.html /config/public_html/index.html

if [ ! -f /config/includes.txt ]; then
  echo "proxy.conf
ssl.conf
dhparams.pem" >/config/includes.txt
  echo "Add a list of includes in the /config/includes.txt file to migrate over from SWAG. Relative to the Nginx folder within the appdata folder. i.e. use sample.conf instead of /config/nginx/sample.conf.
This is useful if you have any includes in your Nginx configs but also works for any folder/file within the Nginx folder.
This only works for files within the nginx directory!
Restart the container when you are done"
  sleep infinity
fi

# permissions
chown -R abc:abc \
  /config \
  /var/lib/nginx \
  /var/tmp/nginx
chmod -R g+w \
  /config/{nginx,public_html}
chmod -R 644 /etc/logrotate.d
